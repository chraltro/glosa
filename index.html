<!DOCTYPE html>
<html lang="en" class="theme-dusk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flash Summarizer Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEzIDJMMy4xNCA4LjVMMi41IDEwTDMgMTFIMTJMMTEgMTlMMjEgMTFIMTJMMTMgMloiIGZpbGw9IiM2MzY2ZjEiLz4KPHN2Zz4K" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#4f46e5">
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #8b5cf6;
            --success: #10b981; --danger: #ef4444;
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-secondary-rgb: 31, 41, 55; --bg-tertiary: #374151; --bg-quaternary: #4b5563;
            --text-primary: #f3f4f6; --text-secondary: #d1d5db; --text-tertiary: #9ca3af;
            --border: #374151; --border-light: #4b5563;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --blur: blur(8px); --radius: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --user-font-family: 'Inter', sans-serif;
        }
        /* --- Themes --- */
        .theme-light { --primary: #3b82f6; --primary-dark: #2563eb; --bg-primary: #ffffff; --bg-secondary: #f9fafb; --bg-secondary-rgb: 249, 250, 251; --bg-tertiary: #f3f4f6; --bg-quaternary: #e5e7eb; --text-primary: #111827; --text-secondary: #374151; --text-tertiary: #6b7280; --border: #e5e7eb; --border-light: #d1d5db; }
        .theme-forest { --primary: #16a34a; --primary-dark: #15803d; --bg-primary: #1c1917; --bg-secondary: #292524; --bg-secondary-rgb: 41, 37, 36; --bg-tertiary: #44403c; --bg-quaternary: #57534e; --text-primary: #f5f5f4; --text-secondary: #d6d3d1; --text-tertiary: #a8a29e; --border: #44403c; --border-light: #57534e; }
        .theme-rose { --primary: #e11d48; --primary-dark: #be123c; --bg-primary: #1f1d2b; --bg-secondary: #26233a; --bg-secondary-rgb: 38, 35, 58; --bg-tertiary: #3e3a59; --bg-quaternary: #4a4867; --text-primary: #e0def4; --text-secondary: #908caa; --text-tertiary: #6e6a86; --border: #3e3a59; --border-light: #4a4867; }
        .theme-dusk { --primary: #4f46e5; --primary-dark: #4338ca; --bg-primary: #111827; --bg-secondary: #1f2937; --bg-secondary-rgb: 31, 41, 55; --bg-tertiary: #374151; --bg-quaternary: #4b5563; --text-primary: #f3f4f6; --text-secondary: #d1d5db; --text-tertiary: #9ca3af; --border: #374151; --border-light: #4b5563; }
        .theme-ocean { --primary: #0ea5e9; --primary-dark: #0284c7; --bg-primary: #0c1427; --bg-secondary: #121c33; --bg-secondary-rgb: 18, 28, 51; --bg-tertiary: #21304f; --bg-quaternary: #2e4166; --text-primary: #eaf3ff; --text-secondary: #a8bfe0; --text-tertiary: #7a9cc6; --border: #21304f; --border-light: #2e4166; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: auto; overflow: auto; }
        body { font-family: var(--user-font-family); background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; }
        button, input, textarea { font-family: inherit; }
        .icon { display: inline-block; width: 1.25em; height: 1.25em; stroke-width: 2; stroke: currentColor; fill: none; vertical-align: middle; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .hidden { display: none !important; }

        /* --- Layout --- */
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: rgba(var(--bg-secondary-rgb), 0.9); backdrop-filter: var(--blur); border-bottom: 1px solid var(--border); z-index: 10; }
        .header-brand { display: flex; align-items: center; gap: 0.75rem; }
        .header-brand h1 { font-size: 1.5rem; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .main-content { display: flex; flex: 1; }
        
        /* --- Sidebar --- */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .history-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .history-item { 
            display: block; 
            width: 100%; 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.5rem;
            border-radius: var(--radius); 
            cursor: pointer; 
            transition: var(--transition-fast); 
            border: 1px solid transparent; 
            text-align: left; 
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        .history-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .history-item.active { background: var(--primary); color: white; font-weight: 600; }
        .history-item .timestamp { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .history-item .article-count { font-size: 0.75rem; opacity: 0.8; }
        
        /* --- Main Area --- */
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .input-section { padding: 1.5rem; border-bottom: 1px solid var(--border); background: var(--bg-primary); }
        textarea { width: 100%; height: 9rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--primary); }
        textarea:disabled { opacity: 0.7; }
        .main-actions { display: flex; gap: 1rem; margin-top: 1rem; }
        .articles-display { padding: 1.5rem; }
        .articles-container { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); }
        
        /* --- Article Card --- */
        .article-card { background-color: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border); transition: var(--transition); }
        .article-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--border-light); }
        .article-header { width: 100%; padding: 1rem 1.5rem; text-align: left; background: none; border: none; color: inherit; cursor: pointer; transition: var(--transition-fast); }
        .article-header:hover { background-color: var(--bg-tertiary); }
        .article-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0; }
        
        .article-url { 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
            font-size: 0.875rem; 
            color: var(--primary-light); 
            text-decoration: none; 
            margin-top: 0.5rem; 
            transition: var(--transition-fast); 
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            background: rgba(var(--bg-primary), 0.7);
        }
        .article-url:hover { 
            color: var(--primary); 
            background: var(--bg-primary);
        }
        .article-url .icon { 
            width: 1rem; 
            height: 1rem; 
        }
        
        .article-content-wrapper { padding: 1.5rem; border-top: 1px solid var(--border-light); }
        .article-content-wrapper > * + * { margin-top: 1.5rem; } /* Vertical spacing */
        h4 { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .summary-box { background-color: var(--bg-primary); padding: 1rem; border-radius: var(--radius); white-space: pre-line; color: var(--text-secondary); }
        .summary-box ul { padding-left: 1.25rem; margin: 0; }
        .summary-box li { margin-bottom: 0.5rem; }
        details > summary { cursor: pointer; font-weight: 600; color: var(--text-secondary); }
        .full-article-box { margin-top: 0.75rem; padding: 1rem; background-color: var(--bg-primary); border-radius: var(--radius); font-size: 0.875rem; color: var(--text-secondary); white-space: pre-line; max-height: 24rem; overflow-y: auto; }
        .chevron-icon { transition: transform 0.2s ease; }
        .chevron-icon.expanded { transform: rotate(90deg); }
        
        /* --- General Components --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: var(--transition-fast); border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background-color: transparent; color: var(--text-secondary); border-color: var(--border); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .icon-btn { background: none; border: none; padding: 0.5rem; color: var(--text-tertiary); border-radius: 50%; }
        .icon-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .alert-box { padding: 1rem; margin-bottom: 1rem; border-radius: var(--radius); display: flex; gap: 0.75rem; align-items: flex-start; border: 1px solid var(--danger); background-color: rgba(239, 68, 68, 0.1); color: #fca5a5; }
        .placeholder { text-align: center; padding: 4rem 1rem; color: var(--text-tertiary); }
        .placeholder .icon { width: 4rem; height: 4rem; margin: 0 auto 1rem; opacity: 0.3; }
        
        /* --- Login & Modals --- */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: var(--blur); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-xl); width: 90%; max-width: 480px; box-shadow: var(--shadow-xl); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 1.5rem; text-align: center; }
        .modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-weight: 500; color: var(--text-secondary); font-size: 0.875rem; }
        .form-group input { padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); text-align: center; font-size: 0.875rem; color: var(--text-tertiary); }
        .modal-footer a { color: var(--primary-light); text-decoration: none; }
        .modal-footer a:hover { text-decoration: underline; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 1rem; }
        .theme-swatch { aspect-ratio: 1 / 1; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-clip: content-box; transition: var(--transition-fast); }
        .theme-swatch:hover { transform: scale(1.1); }
        .theme-swatch.active { border-color: var(--primary); }
        
        /* --- Mobile --- */
        @media (max-width: 768px) {
            .app-header { 
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                padding: 0.75rem; 
            }
            
            .main-content { 
                flex-direction: column; 
                margin-top: 70px; /* Space for fixed header */
            }
            
            .sidebar { 
                width: 100%; 
                height: auto; 
                border-right: none; 
                border-bottom: 1px solid var(--border); 
            }
            .history-list { 
                display: flex; 
                overflow-x: auto; 
                padding-bottom: 0.5rem; 
            }
            .history-item { 
                flex-shrink: 0; 
                margin-right: 0.5rem;
            }
            
            .articles-container { 
                grid-template-columns: 1fr; 
            }
            
            .header-brand h1 { font-size: 1.25rem; }
            .icon-btn span { display: none; }
            .input-section, .articles-display { padding: 1rem; }
        }
    </style>
</head>

<body>
    <!-- App Structure -->
    <div id="appContainer" class="app-container hidden">
        <header class="app-header">
            <div class="header-brand">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                <h1>Flash Summarizer Pro</h1>
            </div>
            <div class="header-actions">
                <button id="expandAllBtn" class="btn btn-secondary hidden">Expand All</button>
                <button id="themeBtn" class="icon-btn" title="Change Theme">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>
                </button>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </header>
        <main class="main-content">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>History</h2>
                </div>
                <div id="historyList" class="history-list"></div>
            </aside>
            <section class="main-area">
                <div class="input-section">
                     <div id="globalError" class="alert-box hidden"></div>
                    <textarea id="articlesInput" placeholder="Paste one or more articles here, separated by a line of '===================='..."></textarea>
                    <div class="main-actions">
                        <button id="submitBtn" class="btn btn-primary">
                            <span id="submitBtnIconContainer">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                            </span>
                            <span id="submitBtnText">Analyze & Save</span>
                        </button>
                        <button id="clearBtn" class="btn btn-secondary">Clear Current</button>
                    </div>
                </div>
                <div class="articles-display">
                    <div id="articlesContainer" class="articles-container"></div>
                    <div id="articlesPlaceholder" class="placeholder">
                         <svg class="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                        <h2>Ready to Summarize</h2>
                        <p>Paste articles in the box above or select a session from your history.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="overlay">
        <div class="modal-box">
            <div class="modal-header"><h2>Welcome</h2></div>
            <div class="modal-body">
                <div id="loginError" class="alert-box hidden"></div>
                <div class="form-group">
                    <label for="googleApiKey">Google AI API Key</label>
                    <input type="password" id="googleApiKey" required>
                </div>
                <div class="form-group">
                    <label for="githubToken">GitHub Token (for History)</label>
                    <input type="password" id="githubToken" required>
                </div>
                <button id="loginBtn" class="btn btn-primary">
                    <span id="loginBtnText">Save & Continue</span>
                     <svg id="loginSpinner" class="icon animate-spin hidden" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                </button>
            </div>
            <div class="modal-footer">
                <p>A GitHub token with 'gist' scope is required to save your history. <a href="https://github.com/settings/tokens/new?scopes=gist&description=FlashSummarizer" target="_blank" rel="noopener noreferrer">Create one here</a>.</p>
            </div>
        </div>
    </div>
    
    <!-- Theme Modal -->
    <div id="themeModal" class="overlay hidden">
        <div class="modal-box">
            <div class="modal-header"><h2>Choose a Theme</h2></div>
            <div id="themeGrid" class="modal-body theme-grid"></div>
        </div>
    </div>

    <!-- Article Template -->
    <template id="articleTemplate">
        <div class="article-card">
            <button class="article-header">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="text-align: left; padding-right: 1rem; flex: 1;">
                        <h3 class="article-title"></h3>
                        <a class="article-url hidden" target="_blank" rel="noopener noreferrer">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                            <span class="url-text"></span>
                        </a>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
                        <div class="loader-icon hidden">
                           <svg class="icon animate-spin" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                        </div>
                        <div class="chevron-icon">
                            <svg class="icon" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"></path></svg>
                        </div>
                    </div>
                </div>
            </button>
            <div class="article-content-wrapper hidden">
                <div class="summary-container"></div>
                <details>
                    <summary>View Full Article</summary>
                    <div class="full-article-box"></div>
                </details>
            </div>
        </div>
    </template>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GIST_FILENAME = 'flash_summarizer_history.json';
            const GIST_DESCRIPTION = 'Flash Summarizer Pro History';
            const UNTITLED_PLACEHOLDER = 'UNTITLED_ARTICLE_NEEDS_GENERATION';
            const BATCH_SIZE = 5; // <-- The new batch size constant

            const dom = {
                appContainer: document.getElementById('appContainer'),
                loginScreen: document.getElementById('loginScreen'),
                googleApiKeyInput: document.getElementById('googleApiKey'),
                githubTokenInput: document.getElementById('githubToken'),
                loginBtn: document.getElementById('loginBtn'),
                loginBtnText: document.getElementById('loginBtnText'),
                loginSpinner: document.getElementById('loginSpinner'),
                loginError: document.getElementById('loginError'),
                globalError: document.getElementById('globalError'),
                logoutBtn: document.getElementById('logoutBtn'),
                expandAllBtn: document.getElementById('expandAllBtn'),
                themeBtn: document.getElementById('themeBtn'),
                themeModal: document.getElementById('themeModal'),
                themeGrid: document.getElementById('themeGrid'),
                historyList: document.getElementById('historyList'),
                articlesInput: document.getElementById('articlesInput'),
                submitBtn: document.getElementById('submitBtn'),
                submitBtnIconContainer: document.getElementById('submitBtnIconContainer'),
                submitBtnText: document.getElementById('submitBtnText'),
                clearBtn: document.getElementById('clearBtn'),
                articlesContainer: document.getElementById('articlesContainer'),
                articlesPlaceholder: document.getElementById('articlesPlaceholder'),
                html: document.documentElement
            };

            let state = {
                googleApiKey: null, githubToken: null, gistId: null, history: [],
                currentArticles: [], activeHistoryId: null, isProcessing: false, expandedArticles: new Set(),
                allExpanded: false,
            };
            
            const themes = [
                { id: 'theme-dusk', color: '#1f2937' }, { id: 'theme-light', color: '#f9fafb' },
                { id: 'theme-forest', color: '#292524' }, { id: 'theme-rose', color: '#26233a' },
                { id: 'theme-ocean', color: '#121c33' }
            ];

            function initializeApp() {
                loadTheme();
                renderThemeModal();
                const savedGoogleKey = localStorage.getItem('googleApiKey');
                const savedGithubToken = localStorage.getItem('githubToken');

                if (savedGoogleKey && savedGithubToken) {
                    state.googleApiKey = savedGoogleKey;
                    state.githubToken = savedGithubToken;
                    dom.appContainer.classList.remove('hidden');
                    dom.loginScreen.classList.add('hidden');
                    loadDataFromGist();
                } else {
                    dom.loginScreen.classList.remove('hidden');
                }
                setupEventListeners();
            }

            function setupEventListeners() {
                dom.loginBtn.addEventListener('click', handleLogin);
                dom.logoutBtn.addEventListener('click', handleLogout);
                dom.expandAllBtn.addEventListener('click', handleExpandAll);
                dom.themeBtn.addEventListener('click', () => dom.themeModal.classList.remove('hidden'));
                dom.themeModal.addEventListener('click', (e) => { if (e.target === dom.themeModal) dom.themeModal.classList.add('hidden'); });
                dom.submitBtn.addEventListener('click', handleSubmit);
                dom.clearBtn.addEventListener('click', clearCurrentView);
                dom.articlesContainer.addEventListener('click', handleArticleClick);
                dom.historyList.addEventListener('click', handleHistoryClick);
            }

            async function handleLogin(e) {
                e.preventDefault();
                setButtonLoading(dom.loginBtn, true, dom.loginBtnText, dom.loginSpinner);
                hideError('loginError');
                const googleKey = dom.googleApiKeyInput.value.trim();
                const githubToken = dom.githubTokenInput.value.trim();

                try {
                    await Promise.all([
                        fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${googleKey}`).then(res => { if (!res.ok) throw new Error('Invalid Google API Key.'); }),
                        fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${githubToken}` } }).then(res => { if (!res.ok) throw new Error('Invalid GitHub Token.'); })
                    ]);

                    state.googleApiKey = googleKey; state.githubToken = githubToken;
                    localStorage.setItem('googleApiKey', googleKey); localStorage.setItem('githubToken', githubToken);
                    
                    dom.appContainer.classList.remove('hidden'); dom.loginScreen.classList.add('hidden');
                    await loadDataFromGist();
                } catch (error) {
                    showError(error.message, 'loginError');
                } finally {
                    setButtonLoading(dom.loginBtn, false, dom.loginBtnText, dom.loginSpinner);
                }
            }

            function handleLogout() {
                localStorage.clear();
                window.location.reload();
            }
            
            async function loadDataFromGist() {
                try {
                    const response = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${state.githubToken}` } });
                    if (!response.ok) throw new Error('Could not fetch Gists.');
                    const gists = await response.json();
                    const existingGist = gists.find(g => g.files && g.files[GIST_FILENAME]);

                    if (existingGist) {
                        state.gistId = existingGist.id;
                        const fileUrl = existingGist.files[GIST_FILENAME].raw_url + `?t=${Date.now()}`;
                        const gistContentResponse = await fetch(fileUrl);
                        const gistData = await gistContentResponse.json();
                        state.history = gistData.history || [];
                    } else {
                        state.history = [];
                    }
                    renderHistory();
                    updatePlaceholder();
                } catch (error) {
                    showError("Could not load history from Gist. It may be empty or there's a network issue.", 'globalError');
                }
            }
            
            async function saveDataToGist() {
                const dataToSave = { history: state.history };
                const headers = { 'Authorization': `token ${state.githubToken}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' };
                const body = JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(dataToSave, null, 2) } } });
                const url = state.gistId ? `https://api.github.com/gists/${state.gistId}` : 'https://api.github.com/gists';
                const method = state.gistId ? 'PATCH' : 'POST';
                const requestBody = state.gistId ? body : JSON.stringify({ description: GIST_DESCRIPTION, public: false, ...JSON.parse(body) });

                try {
                    const response = await fetch(url, { method, headers, body: requestBody });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save to Gist.');
                    }
                    if (method === 'POST') {
                        const newGist = await response.json();
                        state.gistId = newGist.id;
                    }
                } catch (error) {
                    console.error("Gist save error:", error);
                    showError(error.message, 'globalError');
                }
            }

            function parseArticles(text) {
                let articles = [];
                const separatorRegex = /\n\s*={10,}\s*\n/;
                let sections = text.split(separatorRegex).filter(section => section.trim().length > 0);

                sections.forEach((section, index) => {
                    const article = createArticleFromText(section.trim(), index);
                    if (article) {
                        articles.push(article);
                    }
                });
                return articles;
            }

            function createArticleFromText(text, index) {
                if (!text || text.trim().length < 50) return null;

                const lines = text.split('\n');
                let title = UNTITLED_PLACEHOLDER;
                let url = null;
                let contentStartIndex = 0;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.toUpperCase().startsWith('URL:')) {
                        url = line.substring(4).trim();
                    } else if (line.toUpperCase().startsWith('TITLE:')) {
                        title = line.substring(6).trim();
                        contentStartIndex = i + 1;
                        while (contentStartIndex < lines.length && lines[contentStartIndex].trim() === '') {
                            contentStartIndex++;
                        }
                        break;
                    }
                }
                
                if (title === UNTITLED_PLACEHOLDER) {
                    const junkHeaderPatterns = [/^article \d+\/\d+/i, /^-{5,}$/i, /^_{5,}$/i];
                    while (contentStartIndex < lines.length && (junkHeaderPatterns.some(p => p.test(lines[contentStartIndex].trim())) || lines[contentStartIndex].trim() === '')) {
                        contentStartIndex++;
                    }
                }

                let content = lines.slice(contentStartIndex).join('\n').trim();
                const endBoilerplateSnippets = ["For subscribers only:", "Subscribers to The Economist can sign up", "__"];
                for (const snippet of endBoilerplateSnippets) {
                    const pos = content.indexOf(snippet);
                    if (pos !== -1) content = content.substring(0, pos).trim();
                }
                content = content.replace(/■\s*$/, '').trim();

                if (title === UNTITLED_PLACEHOLDER) {
                    const contentLines = content.split('\n').filter(l => l.trim());
                     for (let i = 0; i < Math.min(contentLines.length, 5); i++) {
                        const line = contentLines[i].trim();
                        if (line.length > 10 && line.length < 150 && line !== line.toUpperCase()) {
                            title = line;
                            break;
                        }
                    }
                }

                return {
                    id: Date.now() + index, title, content, url,
                    summary: null, isLoading: true, error: null
                };
            }
            
            async function generateBatchSummaries(articlesToSummarize) {
                let batchPrompt = `For each article below, provide a response based on the instructions.
Always start your response for an article with "--- ARTICLE [number] ---".

INSTRUCTIONS:
1. Generate a 5-bullet-point summary in markdown list format.
2. If an article's provided title is "${UNTITLED_PLACEHOLDER}", you MUST FIRST generate a new, concise title. Format it as: "GENERATED_TITLE: [Your new title]". Then, on a new line, provide the 5-point summary.

ARTICLES:\n\n`;
                articlesToSummarize.forEach((article, index) => {
                    batchPrompt += `--- ARTICLE ${index + 1} ---\nTITLE: ${article.title}\nCONTENT: ${article.content.substring(0, 8000)}\n\n`;
                });

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${state.googleApiKey}`;
                
                const response = await fetch(API_URL, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: batchPrompt }] }],
                        generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed: ${response.status}`);
                }
                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("AI response was empty or invalid.");
                }

                return data.candidates[0].content.parts[0].text;
            }
            
            function processApiResponse(responseText, articles) {
                const sections = responseText.split(/--- ARTICLE \d+ ---/).slice(1);
                
                articles.forEach((article, index) => {
                    const section = sections[index] ? sections[index].trim() : '';
                    if (!section) {
                        article.error = "No summary was returned for this article.";
                    } else {
                        const lines = section.split('\n');
                        if (lines[0].startsWith('GENERATED_TITLE:')) {
                            article.title = lines[0].replace('GENERATED_TITLE:', '').trim();
                            article.summary = lines.slice(1).join('\n').trim();
                        } else {
                            article.summary = section;
                        }
                    }
                    article.isLoading = false;
                });
            }

            // --- ** CORE LOGIC (UPDATED WITH BATCHING) ** ---
            async function handleSubmit() {
                if (!dom.articlesInput.value.trim()) {
                    showError('Please paste some text to analyze.', 'globalError');
                    return;
                }
                
                setProcessing(true);
                clearCurrentView();
                hideError('globalError');

                try {
                    const inputText = dom.articlesInput.value;
                    state.currentArticles = parseArticles(inputText);
                    
                    if (state.currentArticles.length === 0) {
                        showError('No valid articles found. Ensure articles are separated correctly and have enough content.', 'globalError');
                        setProcessing(false);
                        return;
                    }
                    
                    // Initially, render all articles in their loading state.
                    renderArticles();

                    // *** NEW BATCHING LOGIC ***
                    // Process articles in chunks to avoid API token limits.
                    for (let i = 0; i < state.currentArticles.length; i += BATCH_SIZE) {
                        const batch = state.currentArticles.slice(i, i + BATCH_SIZE);
                        console.log(`Processing batch ${Math.floor(i / BATCH_SIZE) + 1}: articles ${i + 1} to ${i + batch.length}`);

                        const apiResponseText = await generateBatchSummaries(batch);
                        processApiResponse(apiResponseText, batch);
                        
                        // Re-render the articles after each batch completes.
                        // This will update the UI progressively.
                        renderArticles(); 
                    }
                    // *** END OF BATCHING LOGIC ***

                    // Now that all batches are processed, save the complete session to history.
                    const newHistoryEntry = { id: Date.now(), timestamp: new Date().toISOString(), articles: state.currentArticles };
                    state.history.unshift(newHistoryEntry);
                    state.activeHistoryId = newHistoryEntry.id;
                    await saveDataToGist();
                    renderHistory();

                } catch (error) {
                    console.error('Error during batch processing:', error);
                    showError('Error processing articles: ' + error.message, 'globalError');
                    if (state.currentArticles && Array.isArray(state.currentArticles)) {
                        state.currentArticles.forEach(article => {
                            if (article && article.isLoading) { // Only mark failing ones
                                article.isLoading = false;
                                article.error = "Processing failed for this batch. " + error.message;
                            }
                        });
                        renderArticles();
                    }
                }
                
                setProcessing(false);
            }

            // --- Rendering ---
            function renderHistory() {
                dom.historyList.innerHTML = '';
                state.history.forEach(entry => {
                    const el = document.createElement('button');
                    el.className = `history-item ${entry.id === state.activeHistoryId ? 'active' : ''}`;
                    el.dataset.id = entry.id;
                    el.innerHTML = `<div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div><div class="article-count">${entry.articles.length} article(s)</div>`;
                    dom.historyList.appendChild(el);
                });
            }
            
            function renderArticles() {
                dom.articlesContainer.innerHTML = '';
                state.currentArticles.forEach(article => dom.articlesContainer.appendChild(createArticleElement(article)));
                updatePlaceholder();
                updateExpandAllButton();
                
                // Show/hide expand all button based on whether we have articles
                if (state.currentArticles.length > 0) {
                    dom.expandAllBtn.classList.remove('hidden');
                } else {
                    dom.expandAllBtn.classList.add('hidden');
                }
            }

            function renderArticle(article) {
                const existingEl = document.querySelector(`.article-card[data-id='${article.id}']`);
                if (existingEl) existingEl.replaceWith(createArticleElement(article));
            }

            function createArticleElement(article) {
                const template = document.getElementById('articleTemplate').content.cloneNode(true);
                const card = template.querySelector('.article-card');
                card.dataset.id = article.id;
                template.querySelector('.article-title').textContent = article.title;
                template.querySelector('.full-article-box').textContent = article.content;

                const urlElement = template.querySelector('.article-url');
                if (article.url) {
                    urlElement.href = article.url;
                    const urlText = template.querySelector('.url-text');
                    try {
                        const domain = new URL(article.url).hostname.replace('www.', '');
                        urlText.textContent = domain;
                    } catch {
                        urlText.textContent = 'Source';
                    }
                    urlElement.classList.remove('hidden');
                    urlElement.addEventListener('click', (e) => e.stopPropagation());
                } else {
                    urlElement.classList.add('hidden');
                }

                const loaderIcon = template.querySelector('.loader-icon');
                const summaryContainer = template.querySelector('.summary-container');
                const chevronIcon = template.querySelector('.chevron-icon');
                const contentWrapper = template.querySelector('.article-content-wrapper');
                
                if (article.isLoading) {
                    loaderIcon.classList.remove('hidden');
                    summaryContainer.innerHTML = `<p>Generating summary...</p>`;
                } else if (article.error) {
                    summaryContainer.innerHTML = `<div class="alert-box"><strong>Error:</strong> ${article.error}</div>`;
                } else if (article.summary) {
                    loaderIcon.classList.add('hidden');
                    const summaryHtml = article.summary.split('\n').map(line => line.trim()).filter(line => line).map(line => `<li>${line.replace(/^[\*•-]\s*/, '')}</li>`).join('');
                    summaryContainer.innerHTML = `<h4>5-Point Summary</h4><div class="summary-box"><ul>${summaryHtml}</ul></div>`;
                }

                if (state.expandedArticles.has(article.id)) {
                    contentWrapper.classList.remove('hidden');
                    chevronIcon.classList.add('expanded');
                } else {
                    contentWrapper.classList.add('hidden');
                    chevronIcon.classList.remove('expanded');
                }
                
                return template;
            }
            
            function renderThemeModal() {
                dom.themeGrid.innerHTML = '';
                themes.forEach(theme => {
                    const swatch = document.createElement('div');
                    swatch.className = 'theme-swatch';
                    swatch.style.backgroundColor = theme.color;
                    swatch.dataset.theme = theme.id;
                    if (localStorage.getItem('flashSummarizerTheme') === theme.id) swatch.classList.add('active');
                    swatch.addEventListener('click', () => {
                        applyTheme(theme.id);
                        document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
                        swatch.classList.add('active');
                    });
                    dom.themeGrid.appendChild(swatch);
                });
            }
            // --- UI Interaction & Helpers ---
            function handleExpandAll() {
                if (state.allExpanded) {
                    state.expandedArticles.clear();
                    state.allExpanded = false;
                    dom.expandAllBtn.textContent = 'Expand All';
                } else {
                    state.currentArticles.forEach(article => {
                        state.expandedArticles.add(article.id);
                    });
                    state.allExpanded = true;
                    dom.expandAllBtn.textContent = 'Collapse All';
                }
                renderArticles();
            }
            
            function handleArticleClick(e) {
                const header = e.target.closest('.article-header');
                if (!header) return;
                
                const card = header.closest('.article-card');
                const articleIdStr = card.dataset.id;
                const articleId = parseInt(articleIdStr, 10);
                
                const wasExpanded = state.expandedArticles.has(articleId);
                const cardElements = Array.from(dom.articlesContainer.children);
                const currentIndex = cardElements.findIndex(el => el.dataset.id === articleIdStr);
                
                if (currentIndex !== -1) {
                    if (wasExpanded) {
                        // Collapse the entire row
                        collapseCardsInRow(currentIndex, cardElements);
                    } else {
                        // Expand the entire row
                        expandCardsInRow(currentIndex, cardElements);
                    }
                }
                
                updateExpandAllButton();
                renderArticles();
            }
            
            function expandCardsInRow(clickedIndex, cardElements) {
                const containerWidth = dom.articlesContainer.offsetWidth;
                const cardWidth = 400 + 24; // minmax(400px, 1fr) + gap
                const cardsPerRow = Math.floor(containerWidth / cardWidth) || 1;
                
                const rowStartIndex = Math.floor(clickedIndex / cardsPerRow) * cardsPerRow;
                const rowEndIndex = Math.min(rowStartIndex + cardsPerRow, cardElements.length);
                
                for (let i = rowStartIndex; i < rowEndIndex; i++) {
                    const cardId = parseInt(cardElements[i].dataset.id, 10);
                    state.expandedArticles.add(cardId);
                }
            }
            
            function collapseCardsInRow(clickedIndex, cardElements) {
                const containerWidth = dom.articlesContainer.offsetWidth;
                const cardWidth = 400 + 24; // minmax(400px, 1fr) + gap
                const cardsPerRow = Math.floor(containerWidth / cardWidth) || 1;
                
                const rowStartIndex = Math.floor(clickedIndex / cardsPerRow) * cardsPerRow;
                const rowEndIndex = Math.min(rowStartIndex + cardsPerRow, cardElements.length);
                
                for (let i = rowStartIndex; i < rowEndIndex; i++) {
                    const cardId = parseInt(cardElements[i].dataset.id, 10);
                    state.expandedArticles.delete(cardId);
                }
            }
            
            function updateExpandAllButton() {
                const allExpanded = state.currentArticles.every(article => state.expandedArticles.has(article.id));
                state.allExpanded = allExpanded;
                dom.expandAllBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
            }
            
            function handleHistoryClick(e) {
                const item = e.target.closest('.history-item');
                if (!item) return;
                const id = parseInt(item.dataset.id, 10);
                const historyEntry = state.history.find(entry => entry.id === id);
                if (historyEntry) {
                    state.currentArticles = historyEntry.articles.map(a => ({...a})); // Create copies
                    state.activeHistoryId = id;
                    dom.articlesInput.value = ''; 
                    state.expandedArticles.clear();
                    renderArticles(); 
                    renderHistory();
                }
            }
            
            function clearCurrentView() {
                state.currentArticles = []; 
                state.activeHistoryId = null;
                state.expandedArticles.clear();
                state.allExpanded = false;
                renderArticles(); 
                renderHistory();
            }

            function setProcessing(isLoading) {
                state.isProcessing = isLoading;
                dom.submitBtn.disabled = isLoading;
                dom.articlesInput.disabled = isLoading;
                const iconContainer = dom.submitBtnIconContainer;
                const textEl = dom.submitBtnText;
                
                if(isLoading) {
                    iconContainer.innerHTML = `<svg class="icon animate-spin" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;
                    textEl.textContent = 'Processing...';
                } else {
                    iconContainer.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>`;
                    textEl.textContent = 'Analyze & Save';
                }
            }
            
            function setButtonLoading(btn, isLoading, textEl, spinnerEl) {
                btn.disabled = isLoading;
                if (textEl) textEl.classList.toggle('hidden', isLoading);
                if (spinnerEl) spinnerEl.classList.toggle('hidden', !isLoading);
            }

            function showError(message, elementId) {
                const el = document.getElementById(elementId);
                el.innerHTML = `<span>${message}</span>`;
                el.classList.remove('hidden');
            }

            function hideError(elementId) {
                document.getElementById(elementId).classList.add('hidden');
            }
            
            function updatePlaceholder() {
                dom.articlesPlaceholder.classList.toggle('hidden', state.currentArticles.length > 0);
            }
            
            function applyTheme(themeId) {
                dom.html.className = themeId;
                localStorage.setItem('flashSummarizerTheme', themeId);
            }

            function loadTheme() {
                const savedTheme = localStorage.getItem('flashSummarizerTheme') || 'theme-dusk';
                applyTheme(savedTheme);
            }

            initializeApp();
        });
    </script>
</body>
</html>