<!DOCTYPE html>
<html lang="en" class="theme-glosa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glosa - Article Summarizer</title>
    <link rel="icon" type="image/svg+xml" href="logo.svg" />
    <meta name="theme-color" content="#D4A373">
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://api.github.com">
    <link rel="preconnect" href="https://generativelanguage.googleapis.com">
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Shared NorrÃ¸n theme -->
    <link rel="stylesheet" href="shared/theme.css">
    <!-- Async font loading for better performance -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet"
        media="print"
        onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet"></noscript>
    <style>
        :root {
            /* Glosa-specific accent color - Bronze Amber */
            --app-accent: #D4A373;
            --app-accent-dark: #B88A5C;
            --app-accent-light: #E0C090;
            --app-accent-rgb: 212, 163, 115;
        }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #8b5cf6;
            --success: #10b981; --danger: #ef4444;
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-secondary-rgb: 31, 41, 55; --bg-tertiary: #374151; --bg-quaternary: #4b5563;
            --text-primary: #f3f4f6; --text-secondary: #d1d5db; --text-tertiary: #9ca3af;
            --border: #374151; --border-light: #4b5563;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --blur: blur(8px); --radius: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --user-font-family: 'Inter', sans-serif;
        }
        /* --- Themes --- */
        .theme-light { --primary: #3b82f6; --primary-dark: #2563eb; --bg-primary: #ffffff; --bg-secondary: #f9fafb; --bg-secondary-rgb: 249, 250, 251; --bg-tertiary: #f3f4f6; --bg-quaternary: #e5e7eb; --text-primary: #111827; --text-secondary: #374151; --text-tertiary: #6b7280; --border: #e5e7eb; --border-light: #d1d5db; }
        .theme-forest { --primary: #16a34a; --primary-dark: #15803d; --bg-primary: #1c1917; --bg-secondary: #292524; --bg-secondary-rgb: 41, 37, 36; --bg-tertiary: #44403c; --bg-quaternary: #57534e; --text-primary: #f5f5f4; --text-secondary: #d6d3d1; --text-tertiary: #a8a29e; --border: #44403c; --border-light: #57534e; }
        .theme-rose { --primary: #e11d48; --primary-dark: #be123c; --bg-primary: #1f1d2b; --bg-secondary: #26233a; --bg-secondary-rgb: 38, 35, 58; --bg-tertiary: #3e3a59; --bg-quaternary: #4a4867; --text-primary: #e0def4; --text-secondary: #908caa; --text-tertiary: #6e6a86; --border: #3e3a59; --border-light: #4a4867; }
        .theme-dusk { --primary: #4f46e5; --primary-dark: #4338ca; --bg-primary: #111827; --bg-secondary: #1f2937; --bg-secondary-rgb: 31, 41, 55; --bg-tertiary: #374151; --bg-quaternary: #4b5563; --text-primary: #f3f4f6; --text-secondary: #d1d5db; --text-tertiary: #9ca3af; --border: #374151; --border-light: #4b5563; }
        .theme-ocean { --primary: #0ea5e9; --primary-dark: #0284c7; --bg-primary: #0c1427; --bg-secondary: #121c33; --bg-secondary-rgb: 18, 28, 51; --bg-tertiary: #21304f; --bg-quaternary: #2e4166; --text-primary: #eaf3ff; --text-secondary: #a8bfe0; --text-tertiary: #7a9cc6; --border: #21304f; --border-light: #2e4166; }
        .theme-glosa { --primary: #D4A373; --primary-dark: #B88A5C; --primary-light: #E0C090; --bg-primary: #111827; --bg-secondary: #1f2937; --bg-secondary-rgb: 31, 41, 55; --bg-tertiary: #374151; --bg-quaternary: #4b5563; --text-primary: #f3f4f6; --text-secondary: #d1d5db; --text-tertiary: #9ca3af; --border: #374151; --border-light: #4b5563; }
        .theme-glosa-light { --primary: #D4A373; --primary-dark: #B88A5C; --primary-light: #E0C090; --bg-primary: #ffffff; --bg-secondary: #f9fafb; --bg-secondary-rgb: 249, 250, 251; --bg-tertiary: #f3f4f6; --bg-quaternary: #e5e7eb; --text-primary: #111827; --text-secondary: #374151; --text-tertiary: #6b7280; --border: #e5e7eb; --border-light: #d1d5db; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: auto; overflow: auto; }
        body { font-family: var(--user-font-family); background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; }
        button, input, textarea { font-family: inherit; }
        .icon { display: inline-block; width: 1.25em; height: 1.25em; stroke-width: 2; stroke: currentColor; fill: none; vertical-align: middle; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* --- Layout --- */
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: rgba(var(--bg-secondary-rgb), 0.9); backdrop-filter: var(--blur); border-bottom: 1px solid var(--border); z-index: 10; }
        .header-brand { display: flex; align-items: center; gap: 0.75rem; }
        .header-brand h1 { font-size: 1.5rem; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .main-content { display: flex; flex: 1; }
        
        /* --- Sidebar --- */
        .sidebar { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .history-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .history-item { 
            display: block; 
            width: 100%; 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.5rem;
            border-radius: var(--radius); 
            cursor: pointer; 
            transition: var(--transition-fast); 
            border: 1px solid transparent; 
            text-align: left; 
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        .history-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .history-item.active { background: var(--primary); color: white; font-weight: 600; }
        .history-item .timestamp { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; }
        .history-item .article-count { font-size: 0.75rem; opacity: 0.8; }

        /* --- Tooltip --- */
        .tooltip { position: fixed; z-index: 1000; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; max-width: 300px; box-shadow: var(--shadow-xl); pointer-events: none; opacity: 0; transition: opacity 0.2s ease; }
        .tooltip.show { opacity: 1; }
        .tooltip-title { font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.875rem; }
        .tooltip-preview { font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; max-height: 100px; overflow: hidden; text-overflow: ellipsis; }

        /* --- Toast Notifications --- */
        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; max-width: 400px; }
        .toast { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; font-size: 0.875rem; }
        .toast-message { font-size: 0.75rem; color: var(--text-secondary); }
        .toast-actions { display: flex; gap: 0.5rem; }
        .toast-btn { padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; transition: var(--transition-fast); }
        .toast-btn:hover { background: var(--bg-quaternary); }

        /* --- Main Area --- */
        .main-area { flex: 1; display: flex; flex-direction: column; }
        .input-section { padding: 1.5rem; border-bottom: 1px solid var(--border); background: var(--bg-primary); }
        textarea { width: 100%; height: 9rem; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--primary); }
        textarea:disabled { opacity: 0.7; }
        .main-actions { display: flex; gap: 1rem; margin-top: 1rem; }
        .progress-bar-container { width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: var(--radius); overflow: hidden; margin-top: 1rem; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); transition: width 0.3s ease; }
        .progress-text { font-size: 0.875rem; color: var(--text-secondary); text-align: center; margin-top: 0.5rem; }
        .articles-display { padding: 1.5rem; }
        .articles-container { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); }
        
        /* --- Article Card --- */
        .article-card { background-color: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border); transition: var(--transition); }
        .article-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--border-light); }
        .article-header { width: 100%; padding: 1rem 1.5rem; text-align: left; background: none; border: none; color: inherit; cursor: pointer; transition: var(--transition-fast); }
        .article-header:hover { background-color: var(--bg-tertiary); }
        .article-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0; }
        
        .article-url { 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
            font-size: 0.875rem; 
            color: var(--primary-light); 
            text-decoration: none; 
            margin-top: 0.5rem; 
            transition: var(--transition-fast); 
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            background: rgba(var(--bg-primary), 0.7);
        }
        .article-url:hover { 
            color: var(--primary); 
            background: var(--bg-primary);
        }
        .article-url .icon { 
            width: 1rem; 
            height: 1rem; 
        }
        
        .article-content-wrapper { padding: 1.5rem; border-top: 1px solid var(--border-light); }
        .article-content-wrapper > * + * { margin-top: 1.5rem; } /* Vertical spacing */
        h4 { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .summary-box { background-color: var(--bg-primary); padding: 1rem; border-radius: var(--radius); white-space: pre-line; color: var(--text-secondary); }
        .summary-box ul { padding-left: 1.25rem; margin: 0; }
        .summary-box li { margin-bottom: 0.5rem; }
        details > summary { cursor: pointer; font-weight: 600; color: var(--text-secondary); }
        .full-article-box { margin-top: 0.75rem; padding: 1rem; background-color: var(--bg-primary); border-radius: var(--radius); font-size: 0.875rem; color: var(--text-secondary); white-space: pre-line; max-height: 24rem; overflow-y: auto; }
        .chevron-icon { transition: transform 0.2s ease; }
        .chevron-icon.expanded { transform: rotate(90deg); }
        
        /* --- General Components --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: var(--transition-fast); border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn-secondary { background-color: transparent; color: var(--text-secondary); border-color: var(--border); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .icon-btn { background: none; border: none; padding: 0.5rem; color: var(--text-tertiary); border-radius: 50%; }
        .icon-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .alert-box { padding: 1rem; margin-bottom: 1rem; border-radius: var(--radius); display: flex; gap: 0.75rem; align-items: flex-start; border: 1px solid var(--danger); background-color: rgba(239, 68, 68, 0.1); color: #fca5a5; }
        .placeholder { text-align: center; padding: 4rem 1rem; color: var(--text-tertiary); }
        .placeholder .icon { width: 4rem; height: 4rem; margin: 0 auto 1rem; opacity: 0.3; }
        
        /* --- Login & Modals --- */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: var(--blur); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-xl); width: 90%; max-width: 480px; box-shadow: var(--shadow-xl); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 1.5rem; text-align: center; }
        .modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-weight: 500; color: var(--text-secondary); font-size: 0.875rem; }
        .form-group input { padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); text-align: center; font-size: 0.875rem; color: var(--text-tertiary); }
        .modal-footer a { color: var(--primary-light); text-decoration: none; }
        .modal-footer a:hover { text-decoration: underline; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 1rem; }
        .theme-swatch { aspect-ratio: 1 / 1; border-radius: 50%; cursor: pointer; border: 3px solid transparent; background-clip: content-box; transition: var(--transition-fast); }
        .theme-swatch:hover { transform: scale(1.1); }
        .theme-swatch.active { border-color: var(--primary); }
        
        /* --- Mobile --- */
        /* --- Wayfinder Logo Link --- */
        .wayfinder-link {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
            opacity: 0.6;
            transition: var(--transition-fast);
        }
        .wayfinder-link:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .wayfinder-link img {
            width: 48px;
            height: 48px;
            display: block;
        }

        @media (max-width: 768px) {
            .wayfinder-link {
                width: 40px;
                height: 40px;
                bottom: 0.75rem;
                right: 0.75rem;
            }
            .wayfinder-link img {
                width: 40px;
                height: 40px;
            }

            .app-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                padding: 0.75rem;
            }

            .main-content {
                flex-direction: column;
                margin-top: 70px; /* Space for fixed header */
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            .history-list {
                display: flex;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            .history-item {
                flex-shrink: 0;
                margin-right: 0.5rem;
            }

            .articles-container {
                grid-template-columns: 1fr;
            }

            .header-brand h1 { font-size: 1.25rem; }
            .icon-btn span { display: none; }
            .input-section, .articles-display { padding: 1rem; }
        }
    </style>
</head>

<body>
    <!-- Wayfinder Logo Link -->
    <a href="../wayfinder/index.html" class="wayfinder-link" title="Back to Wayfinder">
        <img src="wayfinder_logo.svg" alt="Wayfinder" />
    </a>

    <!-- App Structure -->
    <div id="appContainer" class="app-container hidden">
        <header class="app-header">
            <div class="header-brand">
                <img src="logo.svg" alt="Glosa logo" style="height: 1.5em;" />
                <h1>Glosa</h1>
            </div>
            <div class="header-actions">
                <button id="statsBtn" class="btn btn-secondary hidden" title="View statistics">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    Stats
                </button>
                <button id="expandAllBtn" class="btn btn-secondary hidden">Expand All</button>
                <button id="exportBtn" class="btn btn-secondary hidden" title="Export current session">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Export
                </button>
                <button id="settingsBtn" class="icon-btn" title="Settings">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="themeBtn" class="icon-btn" title="Change Theme">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>
                </button>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </header>
        <main class="main-content">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>History</h2>
                    <button id="clearHistoryBtn" class="icon-btn" title="Clear all history" style="color: var(--danger);">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                <div style="padding: 0.5rem 1rem; border-bottom: 1px solid var(--border);">
                    <input
                        type="text"
                        id="historySearch"
                        placeholder="Search history..."
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.875rem;"
                    />
                </div>
                <div id="historyList" class="history-list"></div>
            </aside>
            <section class="main-area">
                <div class="input-section">
                     <div id="globalError" class="alert-box hidden" role="alert"></div>
                    <textarea
                        id="articlesInput"
                        placeholder="Paste one or more articles here, separated by a line of '===================='...."
                        aria-label="Article input"
                        aria-describedby="inputHelp"
                    ></textarea>
                    <div id="inputHelp" class="sr-only">
                        Paste one or more articles. Separate multiple articles with a line of equals signs. Press Ctrl+Enter to analyze.
                    </div>
                    <div class="main-actions">
                        <button id="submitBtn" class="btn btn-primary" aria-label="Analyze articles and save to history">
                            <span id="submitBtnIconContainer" aria-hidden="true">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                            </span>
                            <span id="submitBtnText">Analyze & Save</span>
                        </button>
                        <button id="clearBtn" class="btn btn-secondary" aria-label="Clear current view">Clear Current</button>
                    </div>
                    <div id="progressContainer" class="hidden" role="status" aria-live="polite">
                        <div class="progress-bar-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="progressText" class="progress-text"></div>
                    </div>
                </div>
                <div class="articles-display">
                    <div id="articlesContainer" class="articles-container"></div>
                    <div id="articlesPlaceholder" class="placeholder">
                         <svg class="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                        <h2>Ready to Summarize</h2>
                        <p>Paste articles in the box above or select a session from your history.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="overlay">
        <div class="modal-box">
            <div class="modal-header"><h2>Welcome to Glosa</h2></div>
            <div class="modal-body">
                <div id="loginError" class="alert-box hidden"></div>
                <div id="loginStatus" class="hidden" style="text-align: center; padding: 1rem; color: var(--text-secondary);"></div>

                <!-- OAuth Flow -->
                <div id="oauthFlow" class="form-group" style="display: flex; flex-direction: column; gap: 1rem;">
                    <button id="googleSignInBtn" class="btn btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                            <path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span>Sign in with Google</span>
                    </button>

                    <button id="githubConnectBtn" class="btn btn-secondary hidden" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                        <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        <span>Connect GitHub</span>
                    </button>
                </div>

                <!-- Manual Entry Fallback -->
                <div id="manualEntryLink" class="hidden" style="text-align: center; margin-top: 1rem;">
                    <button id="showManualBtn" class="text-sm" style="color: var(--text-tertiary); text-decoration: underline; background: none; border: none; cursor: pointer;">
                        Or enter keys manually
                    </button>
                </div>

                <div id="manualEntryForm" class="hidden" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="form-group">
                        <label for="googleApiKey">Gemini API Key</label>
                        <input type="password" id="googleApiKey" placeholder="Enter your Gemini API key">
                    </div>
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" placeholder="Enter your GitHub token (for syncing history)">
                    </div>
                    <button id="loginBtn" class="btn btn-primary">
                        <span id="loginBtnText">Save & Continue</span>
                        <svg id="loginSpinner" class="icon animate-spin hidden" style="width: 1.25rem; height: 1.25rem;" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                    </button>
                </div>

                <div id="loadingSpinner" class="hidden" style="text-align: center; padding: 2rem;">
                    <svg class="icon animate-spin" style="width: 2rem; height: 2rem; margin: 0 auto;" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                </div>
            </div>
            <div class="modal-footer">
                <p>Sign in once and your API keys sync across all devices automatically.</p>
            </div>
        </div>
    </div>
    
    <!-- Theme Modal -->
    <div id="themeModal" class="overlay hidden">
        <div class="modal-box">
            <div class="modal-header"><h2>Choose a Theme</h2></div>
            <div id="themeGrid" class="modal-body theme-grid"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="overlay hidden">
        <div class="modal-box">
            <div class="modal-header"><h2>Settings</h2></div>
            <div class="modal-body">
                <div id="settingsError" class="alert-box hidden"></div>
                <div id="settingsStatus" class="hidden" style="text-align: center; padding: 1rem; color: var(--text-secondary);"></div>

                <form id="settingsForm" class="form-group">
                    <div class="form-group">
                        <label for="settingsGeminiKey">Gemini API Key</label>
                        <input type="password" id="settingsGeminiKey" placeholder="Enter your Gemini API key" required>
                    </div>
                    <div class="form-group">
                        <label for="settingsGithubToken">GitHub Personal Access Token (Optional)</label>
                        <input type="password" id="settingsGithubToken" placeholder="Enter your GitHub token (for syncing history)">
                        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
                            Need a token? <a href="https://github.com/settings/tokens/new?scopes=gist&description=Glosa" target="_blank" rel="noopener" style="color: var(--link-color);">Create one here</a> with "gist" scope.
                        </small>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" id="settingsSaveBtn" class="btn btn-primary" style="flex: 1;">
                            Save Keys
                        </button>
                        <button type="button" id="settingsCancelBtn" class="btn btn-secondary" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Article Template -->
    <template id="articleTemplate">
        <div class="article-card">
            <button class="article-header">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="text-align: left; padding-right: 1rem; flex: 1;">
                        <h3 class="article-title"></h3>
                        <a class="article-url hidden" target="_blank" rel="noopener noreferrer">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                            <span class="url-text"></span>
                        </a>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
                        <div class="loader-icon hidden">
                           <svg class="icon animate-spin" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                        </div>
                        <div class="chevron-icon">
                            <svg class="icon" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"></path></svg>
                        </div>
                    </div>
                </div>
            </button>
            <div class="article-content-wrapper hidden">
                <div class="summary-container"></div>
                <details>
                    <summary>View Full Article</summary>
                    <div class="full-article-box"></div>
                </details>
            </div>
        </div>
    </template>

    <script type="module">
        import { initAuth, handleGoogleSignIn, retrieveKeys, saveKeys, getCurrentAuth } from './glosa-auth.js';

        document.addEventListener('DOMContentLoaded', () => {
            const GIST_FILENAME = 'flash_summarizer_history.json';
            const GIST_DESCRIPTION = 'Glosa History';
            const UNTITLED_PLACEHOLDER = 'UNTITLED_ARTICLE_NEEDS_GENERATION';
            const BATCH_SIZE = 5; // <-- The new batch size constant

            const dom = {
                appContainer: document.getElementById('appContainer'),
                loginScreen: document.getElementById('loginScreen'),
                googleApiKeyInput: document.getElementById('googleApiKey'),
                githubTokenInput: document.getElementById('githubToken'),
                loginBtn: document.getElementById('loginBtn'),
                loginBtnText: document.getElementById('loginBtnText'),
                loginSpinner: document.getElementById('loginSpinner'),
                showManualBtn: document.getElementById('showManualBtn'),
                manualEntryForm: document.getElementById('manualEntryForm'),
                manualEntryLink: document.getElementById('manualEntryLink'),
                oauthFlow: document.getElementById('oauthFlow'),
                loginError: document.getElementById('loginError'),
                loginStatus: document.getElementById('loginStatus'),
                loadingSpinner: document.getElementById('loadingSpinner'),
                googleSignInBtn: document.getElementById('googleSignInBtn'),
                githubConnectBtn: document.getElementById('githubConnectBtn'),
                globalError: document.getElementById('globalError'),
                logoutBtn: document.getElementById('logoutBtn'),
                clearHistoryBtn: document.getElementById('clearHistoryBtn'),
                statsBtn: document.getElementById('statsBtn'),
                expandAllBtn: document.getElementById('expandAllBtn'),
                exportBtn: document.getElementById('exportBtn'),
                settingsBtn: document.getElementById('settingsBtn'),
                settingsModal: document.getElementById('settingsModal'),
                settingsForm: document.getElementById('settingsForm'),
                settingsGeminiKey: document.getElementById('settingsGeminiKey'),
                settingsGithubToken: document.getElementById('settingsGithubToken'),
                settingsSaveBtn: document.getElementById('settingsSaveBtn'),
                settingsCancelBtn: document.getElementById('settingsCancelBtn'),
                settingsError: document.getElementById('settingsError'),
                settingsStatus: document.getElementById('settingsStatus'),
                themeBtn: document.getElementById('themeBtn'),
                themeModal: document.getElementById('themeModal'),
                themeGrid: document.getElementById('themeGrid'),
                historySearch: document.getElementById('historySearch'),
                historyList: document.getElementById('historyList'),
                articlesInput: document.getElementById('articlesInput'),
                submitBtn: document.getElementById('submitBtn'),
                submitBtnIconContainer: document.getElementById('submitBtnIconContainer'),
                submitBtnText: document.getElementById('submitBtnText'),
                clearBtn: document.getElementById('clearBtn'),
                progressContainer: document.getElementById('progressContainer'),
                progressBar: document.getElementById('progressBar'),
                progressText: document.getElementById('progressText'),
                articlesContainer: document.getElementById('articlesContainer'),
                articlesPlaceholder: document.getElementById('articlesPlaceholder'),
                html: document.documentElement
            };

            let state = {
                googleApiKey: null,
                githubToken: null,
                gistId: null,
                history: [],
                currentArticles: [],
                activeHistoryId: null,
                isProcessing: false,
                expandedArticles: new Set(),
                allExpanded: false,
                tooltip: null,
                deletedSessions: [] // For undo functionality
            };
            
            const themes = [
                { id: 'theme-glosa', color: '#D4A373' },
                { id: 'theme-glosa-light', color: '#f9fafb' },
                { id: 'theme-dusk', color: '#1f2937' }, { id: 'theme-light', color: '#f9fafb' },
                { id: 'theme-forest', color: '#292524' }, { id: 'theme-rose', color: '#26233a' },
                { id: 'theme-ocean', color: '#121c33' }
            ];

            async function initializeApp() {
                loadTheme();
                renderThemeModal();

                // Initialize Google Auth
                await initAuth();

                // Check localStorage for existing login
                const savedGoogleKey = localStorage.getItem('googleApiKey');
                const savedGithubToken = localStorage.getItem('githubToken');

                if (savedGoogleKey) {
                    state.googleApiKey = savedGoogleKey;
                    state.githubToken = savedGithubToken;
                    dom.appContainer.classList.remove('hidden');
                    dom.loginScreen.classList.add('hidden');
                    await loadDataFromGist();
                } else {
                    dom.loginScreen.classList.remove('hidden');
                    // Show manual entry link
                    dom.manualEntryLink.classList.remove('hidden');
                }
                setupEventListeners();
            }

            function setupEventListeners() {
                // Auth event listeners
                if (dom.googleSignInBtn) dom.googleSignInBtn.addEventListener('click', handleGoogleSignInClick);
                if (dom.showManualBtn) dom.showManualBtn.addEventListener('click', showManualEntry);
                if (dom.loginBtn) dom.loginBtn.addEventListener('click', handleManualSubmit);

                // App event listeners
                dom.logoutBtn.addEventListener('click', handleLogout);
                dom.clearHistoryBtn.addEventListener('click', confirmClearHistory);
                dom.statsBtn.addEventListener('click', showStatistics);
                dom.expandAllBtn.addEventListener('click', handleExpandAll);
                dom.exportBtn.addEventListener('click', handleExport);
                dom.settingsBtn.addEventListener('click', openSettings);
                dom.settingsModal.addEventListener('click', (e) => { if (e.target === dom.settingsModal) closeSettings(); });
                dom.settingsCancelBtn.addEventListener('click', closeSettings);
                dom.settingsForm.addEventListener('submit', handleSettingsSave);
                dom.themeBtn.addEventListener('click', () => dom.themeModal.classList.remove('hidden'));
                dom.themeModal.addEventListener('click', (e) => { if (e.target === dom.themeModal) dom.themeModal.classList.add('hidden'); });
                dom.submitBtn.addEventListener('click', handleSubmit);
                dom.clearBtn.addEventListener('click', clearCurrentView);
                dom.articlesContainer.addEventListener('click', handleArticleClick);
                dom.historyList.addEventListener('click', handleHistoryClick);
                dom.historySearch.addEventListener('input', (e) => handleHistorySearch(e));

                // Keyboard shortcuts
                document.addEventListener('keydown', handleKeyboardShortcuts);
            }

            // Debounce function for performance
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            const handleHistorySearch = debounce((e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderHistory(searchTerm);
            }, 300);

            function handleKeyboardShortcuts(e) {
                // Ctrl+Enter or Cmd+Enter: Submit/Analyze
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !state.isProcessing) {
                    e.preventDefault();
                    if (dom.articlesInput.value.trim()) {
                        handleSubmit();
                    }
                }

                // Escape: Close modals
                if (e.key === 'Escape') {
                    if (!dom.settingsModal.classList.contains('hidden')) {
                        closeSettings();
                    } else if (!dom.themeModal.classList.contains('hidden')) {
                        dom.themeModal.classList.add('hidden');
                    }
                }

                // Ctrl+K or Cmd+K: Focus on input
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    dom.articlesInput.focus();
                }

                // Ctrl+E or Cmd+E: Expand/Collapse all
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    if (state.currentArticles.length > 0) {
                        handleExpandAll();
                    }
                }

                // Ctrl+, or Cmd+,: Open settings
                if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                    e.preventDefault();
                    openSettings();
                }
            }

            function showManualEntry() {
                dom.oauthFlow.classList.add('hidden');
                dom.manualEntryLink.classList.add('hidden');
                dom.manualEntryForm.classList.remove('hidden');
            }

            async function handleGoogleSignInClick() {
                try {
                    dom.loadingSpinner.classList.remove('hidden');
                    dom.oauthFlow.classList.add('hidden');
                    dom.loginStatus.classList.remove('hidden');
                    dom.loginStatus.textContent = 'Signing in with Google...';
                    hideError('loginError');

                    await handleGoogleSignIn();
                    dom.loginStatus.textContent = 'Checking for saved keys...';

                    // Try to retrieve saved keys from Firebase
                    const keys = await retrieveKeys();

                    if (keys && keys.geminiKey) {
                        // Keys found - auto login
                        state.googleApiKey = keys.geminiKey;
                        state.githubToken = keys.githubToken;
                        dom.loginStatus.textContent = 'Keys found! Signing you in...';

                        // Also save to localStorage for faster future logins
                        localStorage.setItem('googleApiKey', keys.geminiKey);
                        if (keys.githubToken) {
                            localStorage.setItem('githubToken', keys.githubToken);
                        }

                        setTimeout(() => {
                            dom.appContainer.classList.remove('hidden');
                            dom.loginScreen.classList.add('hidden');
                            loadDataFromGist();
                        }, 500);
                    } else {
                        // First time - need to enter keys
                        dom.loginStatus.textContent = 'Welcome! Please enter your API keys to get started.';
                        dom.loadingSpinner.classList.add('hidden');
                        dom.manualEntryForm.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Sign-in error:', error);
                    showError(error.message || 'Sign-in failed', 'loginError');
                    dom.loadingSpinner.classList.add('hidden');
                    dom.loginStatus.classList.add('hidden');
                    dom.oauthFlow.classList.remove('hidden');
                    dom.manualEntryLink.classList.remove('hidden');
                }
            }

            async function handleManualSubmit(e) {
                if (e) e.preventDefault();

                const geminiKey = dom.googleApiKeyInput.value.trim();
                const githubToken = dom.githubTokenInput.value.trim();

                if (!geminiKey) {
                    showError('Please enter a Gemini API key', 'loginError');
                    return;
                }

                try {
                    dom.loadingSpinner.classList.remove('hidden');
                    dom.manualEntryForm.classList.add('hidden');
                    dom.loginStatus.classList.remove('hidden');
                    dom.loginStatus.textContent = 'Validating keys...';
                    hideError('loginError');

                    // Validate Gemini key
                    const testResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiKey}`);
                    if (!testResponse.ok) throw new Error('Invalid Gemini API key');

                    dom.loginStatus.textContent = 'Saving keys...';

                    // Save to Firebase if user is signed in
                    const auth = getCurrentAuth();
                    if (auth.googleUser) {
                        await saveKeys(geminiKey, githubToken || null);
                        dom.loginStatus.textContent = 'Keys saved and synced!';
                    } else {
                        // Fallback to localStorage only
                        dom.loginStatus.textContent = 'Keys saved locally';
                    }

                    // Always save to localStorage for quick access
                    localStorage.setItem('googleApiKey', geminiKey);
                    if (githubToken) {
                        localStorage.setItem('githubToken', githubToken);
                    }

                    state.googleApiKey = geminiKey;
                    state.githubToken = githubToken;

                    setTimeout(() => {
                        dom.appContainer.classList.remove('hidden');
                        dom.loginScreen.classList.add('hidden');
                        loadDataFromGist();
                    }, 500);
                } catch (error) {
                    showError(error.message, 'loginError');
                    dom.loadingSpinner.classList.add('hidden');
                    dom.loginStatus.classList.add('hidden');
                    dom.manualEntryForm.classList.remove('hidden');
                }
            }

            function openSettings() {
                // Pre-fill current values
                dom.settingsGeminiKey.value = state.googleApiKey || '';
                dom.settingsGithubToken.value = state.githubToken || '';
                dom.settingsModal.classList.remove('hidden');
                hideError('settingsError');
                dom.settingsStatus.classList.add('hidden');
            }

            function closeSettings() {
                dom.settingsModal.classList.add('hidden');
            }

            async function handleSettingsSave(e) {
                e.preventDefault();

                const geminiKey = dom.settingsGeminiKey.value.trim();
                const githubToken = dom.settingsGithubToken.value.trim();

                if (!geminiKey) {
                    showError('Gemini API key is required', 'settingsError');
                    return;
                }

                try {
                    dom.settingsStatus.classList.remove('hidden');
                    dom.settingsStatus.textContent = 'Validating keys...';
                    hideError('settingsError');

                    // Validate Gemini key
                    const testResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiKey}`);
                    if (!testResponse.ok) throw new Error('Invalid Gemini API key');

                    dom.settingsStatus.textContent = 'Saving keys...';

                    // Save to Firebase if user is signed in
                    const auth = getCurrentAuth();
                    if (auth.googleUser) {
                        await saveKeys(geminiKey, githubToken || null);
                        dom.settingsStatus.textContent = 'Keys saved and synced to Firebase!';
                    } else {
                        dom.settingsStatus.textContent = 'Keys saved locally';
                    }

                    // Always save to localStorage
                    localStorage.setItem('googleApiKey', geminiKey);
                    if (githubToken) {
                        localStorage.setItem('githubToken', githubToken);
                    } else {
                        localStorage.removeItem('githubToken');
                    }

                    // Update state
                    state.googleApiKey = geminiKey;
                    state.githubToken = githubToken;

                    setTimeout(() => {
                        closeSettings();
                        dom.settingsStatus.classList.add('hidden');
                    }, 1500);
                } catch (error) {
                    showError(error.message, 'settingsError');
                    dom.settingsStatus.classList.add('hidden');
                }
            }

            function handleLogout() {
                localStorage.clear();
                window.location.reload();
            }

            function confirmClearHistory() {
                if (state.history.length === 0) {
                    showError('No history to clear', 'globalError');
                    setTimeout(() => hideError('globalError'), 2000);
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="modal-box">
                        <div class="modal-header"><h2>Clear History?</h2></div>
                        <div class="modal-body">
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Are you sure you want to delete all ${state.history.length} session(s) from your history? You can undo this action within 30 seconds.
                            </p>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" id="cancelClearHistory" style="flex: 1;">Cancel</button>
                                <button class="btn btn-primary" id="confirmClearHistory" style="flex: 1; background: var(--danger); border-color: var(--danger);">Delete All</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('cancelClearHistory').addEventListener('click', () => modal.remove());
                document.getElementById('confirmClearHistory').addEventListener('click', async () => {
                    modal.remove();

                    // Save deleted sessions for undo
                    state.deletedSessions = [...state.history];
                    state.history = [];
                    state.activeHistoryId = null;
                    await saveDataToGist();
                    renderHistory();
                    clearCurrentView();

                    // Show toast with undo option
                    showToast('All sessions deleted', 'You can undo this action', 'info', [
                        { label: 'Undo', action: undoDeleteHistory }
                    ], 30000);
                });
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            async function undoDeleteHistory() {
                if (state.deletedSessions.length > 0) {
                    state.history = [...state.deletedSessions];
                    state.deletedSessions = [];
                    await saveDataToGist();
                    renderHistory();
                    showToast('Restored', 'All sessions have been restored', 'success');
                }
            }

            function showToast(title, message, type = 'info', actions = [], duration = 5000) {
                // Create toast container if it doesn't exist
                let container = document.querySelector('.toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container';
                    document.body.appendChild(container);
                }

                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;

                const actionsHTML = actions.length > 0
                    ? `<div class="toast-actions">${actions.map((a, i) => `<button class="toast-btn" data-action="${i}">${a.label}</button>`).join('')}</div>`
                    : '';

                toast.innerHTML = `
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    ${actionsHTML}
                `;

                container.appendChild(toast);

                // Add action listeners
                actions.forEach((action, index) => {
                    const btn = toast.querySelector(`[data-action="${index}"]`);
                    if (btn) {
                        btn.addEventListener('click', () => {
                            action.action();
                            removeToast(toast);
                        });
                    }
                });

                // Show toast with animation
                setTimeout(() => toast.classList.add('show'), 10);

                // Auto-remove toast
                if (duration > 0) {
                    setTimeout(() => removeToast(toast), duration);
                }

                return toast;
            }

            function removeToast(toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }

            async function shareArticle(article) {
                const shareText = `${article.title}\n\n${article.summary}${article.url ? '\n\nSource: ' + article.url : ''}`;

                // Check if Web Share API is available
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: article.title,
                            text: article.summary,
                            url: article.url || window.location.href
                        });
                        showToast('Shared!', 'Article shared successfully', 'success');
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Share failed:', error);
                            fallbackShare(shareText);
                        }
                    }
                } else {
                    fallbackShare(shareText);
                }
            }

            function fallbackShare(text) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="modal-box">
                        <div class="modal-header"><h2>Share Article</h2></div>
                        <div class="modal-body">
                            <textarea
                                id="shareText"
                                readonly
                                style="width: 100%; height: 200px; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.875rem; font-family: inherit;"
                            >${text}</textarea>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <button class="btn btn-primary" id="copyShareText" style="flex: 1;">Copy to Clipboard</button>
                                <button class="btn btn-secondary" id="closeShare" style="flex: 1;">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                const shareTextArea = document.getElementById('shareText');
                shareTextArea.select();

                document.getElementById('copyShareText').addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast('Copied!', 'Share text copied to clipboard', 'success');
                        modal.remove();
                    } catch (error) {
                        console.error('Copy failed:', error);
                        showToast('Error', 'Failed to copy to clipboard', 'error');
                    }
                });

                document.getElementById('closeShare').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            function loadDataFromLocalStorage() {
                try {
                    const savedHistory = localStorage.getItem('glosaHistory');
                    if (savedHistory) {
                        const parsed = JSON.parse(savedHistory);
                        state.history = parsed.history || [];
                    } else {
                        state.history = [];
                    }
                    renderHistory();
                    updatePlaceholder();
                } catch (error) {
                    console.error("Could not load history from localStorage:", error);
                    state.history = [];
                }
            }

            function saveDataToLocalStorage() {
                try {
                    const dataToSave = { history: state.history };
                    localStorage.setItem('glosaHistory', JSON.stringify(dataToSave));
                } catch (error) {
                    console.error("localStorage save error:", error);
                    showError('Could not save history to browser storage.', 'globalError');
                }
            }

            async function loadDataFromGist() {
                if (!state.githubToken) {
                    console.log('No GitHub token, skipping gist load');
                    loadDataFromLocalStorage();
                    return;
                }

                try {
                    const response = await fetch('https://api.github.com/gists', {
                        headers: { 'Authorization': `token ${state.githubToken}` }
                    });
                    if (!response.ok) throw new Error('Could not fetch Gists.');
                    const gists = await response.json();
                    const existingGist = gists.find(g => g.files && g.files[GIST_FILENAME]);

                    if (existingGist) {
                        state.gistId = existingGist.id;
                        const fileUrl = existingGist.files[GIST_FILENAME].raw_url + `?t=${Date.now()}`;
                        const gistContentResponse = await fetch(fileUrl);
                        const gistData = await gistContentResponse.json();
                        state.history = gistData.history || [];
                    } else {
                        state.history = [];
                    }
                    renderHistory();
                    updatePlaceholder();
                } catch (error) {
                    console.error("Gist load error:", error);
                    showError("Could not load history from Gist. Loading from local storage instead.", 'globalError');
                    loadDataFromLocalStorage();
                }
            }

            async function saveDataToGist() {
                if (!state.githubToken) {
                    console.log('No GitHub token, saving to localStorage only');
                    saveDataToLocalStorage();
                    return;
                }

                const dataToSave = { history: state.history };
                const headers = {
                    'Authorization': `token ${state.githubToken}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github+json'
                };
                const body = JSON.stringify({
                    files: { [GIST_FILENAME]: { content: JSON.stringify(dataToSave, null, 2) } }
                });
                const url = state.gistId
                    ? `https://api.github.com/gists/${state.gistId}`
                    : 'https://api.github.com/gists';
                const method = state.gistId ? 'PATCH' : 'POST';
                const requestBody = state.gistId
                    ? body
                    : JSON.stringify({
                        description: GIST_DESCRIPTION,
                        public: false,
                        ...JSON.parse(body)
                    });

                try {
                    const response = await fetch(url, { method, headers, body: requestBody });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save to Gist.');
                    }
                    if (method === 'POST') {
                        const newGist = await response.json();
                        state.gistId = newGist.id;
                    }
                    // Also save to localStorage as backup
                    saveDataToLocalStorage();
                } catch (error) {
                    console.error("Gist save error:", error);
                    showError('Could not save to Gist. Saved locally instead: ' + error.message, 'globalError');
                    saveDataToLocalStorage();
                }
            }

            function parseArticles(text) {
                let articles = [];
                const separatorRegex = /\n\s*={10,}\s*\n/;
                let sections = text.split(separatorRegex).filter(section => section.trim().length > 0);

                sections.forEach((section, index) => {
                    const article = createArticleFromText(section.trim(), index);
                    if (article) {
                        articles.push(article);
                    }
                });
                return articles;
            }

            function createArticleFromText(text, index) {
                if (!text || text.trim().length < 50) return null;

                const lines = text.split('\n');
                let title = UNTITLED_PLACEHOLDER;
                let url = null;
                let contentStartIndex = 0;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.toUpperCase().startsWith('URL:')) {
                        url = line.substring(4).trim();
                    } else if (line.toUpperCase().startsWith('TITLE:')) {
                        title = line.substring(6).trim();
                        contentStartIndex = i + 1;
                        while (contentStartIndex < lines.length && lines[contentStartIndex].trim() === '') {
                            contentStartIndex++;
                        }
                        break;
                    }
                }
                
                if (title === UNTITLED_PLACEHOLDER) {
                    const junkHeaderPatterns = [/^article \d+\/\d+/i, /^-{5,}$/i, /^_{5,}$/i];
                    while (contentStartIndex < lines.length && (junkHeaderPatterns.some(p => p.test(lines[contentStartIndex].trim())) || lines[contentStartIndex].trim() === '')) {
                        contentStartIndex++;
                    }
                }

                let content = lines.slice(contentStartIndex).join('\n').trim();
                const endBoilerplateSnippets = ["For subscribers only:", "Subscribers to The Economist can sign up", "__"];
                for (const snippet of endBoilerplateSnippets) {
                    const pos = content.indexOf(snippet);
                    if (pos !== -1) content = content.substring(0, pos).trim();
                }
                content = content.replace(/â \s*$/, '').trim();

                if (title === UNTITLED_PLACEHOLDER) {
                    const contentLines = content.split('\n').filter(l => l.trim());
                     for (let i = 0; i < Math.min(contentLines.length, 5); i++) {
                        const line = contentLines[i].trim();
                        if (line.length > 10 && line.length < 150 && line !== line.toUpperCase()) {
                            title = line;
                            break;
                        }
                    }
                }

                return {
                    id: Date.now() + index, title, content, url,
                    summary: null, isLoading: true, error: null
                };
            }
            
            async function generateBatchSummaries(articlesToSummarize, retryCount = 0) {
                const MAX_RETRIES = 3;
                const RETRY_DELAY = 2000; // 2 seconds

                let batchPrompt = `For each article below, provide a response based on the instructions.
Always start your response for an article with "--- ARTICLE [number] ---".

INSTRUCTIONS:
1. Generate a 5-bullet-point summary in markdown list format.
2. If an article's provided title is "${UNTITLED_PLACEHOLDER}", you MUST FIRST generate a new, concise title. Format it as: "GENERATED_TITLE: [Your new title]". Then, on a new line, provide the 5-point summary.

ARTICLES:\n\n`;
                articlesToSummarize.forEach((article, index) => {
                    batchPrompt += `--- ARTICLE ${index + 1} ---\nTITLE: ${article.title}\nCONTENT: ${article.content.substring(0, 8000)}\n\n`;
                });

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.googleApiKey}`;

                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: batchPrompt }] }],
                            generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error?.message || `API request failed: ${response.status}`;

                        // Retry on server errors (5xx) or rate limit (429)
                        if ((response.status >= 500 || response.status === 429) && retryCount < MAX_RETRIES) {
                            console.warn(`API request failed (${response.status}), retrying in ${RETRY_DELAY}ms... (attempt ${retryCount + 1}/${MAX_RETRIES})`);
                            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * (retryCount + 1)));
                            return await generateBatchSummaries(articlesToSummarize, retryCount + 1);
                        }

                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0].content) {
                        throw new Error("AI response was empty or invalid.");
                    }

                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    // Retry on network errors
                    if (error.name === 'TypeError' && retryCount < MAX_RETRIES) {
                        console.warn(`Network error, retrying in ${RETRY_DELAY}ms... (attempt ${retryCount + 1}/${MAX_RETRIES})`);
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * (retryCount + 1)));
                        return await generateBatchSummaries(articlesToSummarize, retryCount + 1);
                    }
                    throw error;
                }
            }
            
            function processApiResponse(responseText, articles) {
                const sections = responseText.split(/--- ARTICLE \d+ ---/).slice(1);
                
                articles.forEach((article, index) => {
                    const section = sections[index] ? sections[index].trim() : '';
                    if (!section) {
                        article.error = "No summary was returned for this article.";
                    } else {
                        const lines = section.split('\n');
                        if (lines[0].startsWith('GENERATED_TITLE:')) {
                            article.title = lines[0].replace('GENERATED_TITLE:', '').trim();
                            article.summary = lines.slice(1).join('\n').trim();
                        } else {
                            article.summary = section;
                        }
                    }
                    article.isLoading = false;
                });
            }

            // --- ** CORE LOGIC (UPDATED WITH BATCHING) ** ---
            async function handleSubmit() {
                if (!dom.articlesInput.value.trim()) {
                    showError('Please paste some text to analyze.', 'globalError');
                    return;
                }

                setProcessing(true);
                clearCurrentView();
                hideError('globalError');

                try {
                    const inputText = dom.articlesInput.value;
                    state.currentArticles = parseArticles(inputText);

                    if (state.currentArticles.length === 0) {
                        showError('No valid articles found. Ensure articles are separated correctly and have enough content.', 'globalError');
                        setProcessing(false);
                        return;
                    }

                    // Initially, render all articles in their loading state.
                    renderArticles();

                    // Show progress bar
                    dom.progressContainer.classList.remove('hidden');
                    dom.progressContainer.setAttribute('aria-valuenow', '0');
                    const totalBatches = Math.ceil(state.currentArticles.length / BATCH_SIZE);

                    // *** NEW BATCHING LOGIC ***
                    // Process articles in chunks to avoid API token limits.
                    for (let i = 0; i < state.currentArticles.length; i += BATCH_SIZE) {
                        const batch = state.currentArticles.slice(i, i + BATCH_SIZE);
                        const currentBatch = Math.floor(i / BATCH_SIZE) + 1;
                        console.log(`Processing batch ${currentBatch}: articles ${i + 1} to ${i + batch.length}`);

                        // Update progress
                        const progress = (currentBatch / totalBatches) * 100;
                        dom.progressBar.style.width = `${progress}%`;
                        dom.progressContainer.querySelector('[role="progressbar"]').setAttribute('aria-valuenow', Math.round(progress));
                        dom.progressText.textContent = `Processing batch ${currentBatch} of ${totalBatches}... (${i + 1}-${i + batch.length} of ${state.currentArticles.length} articles)`;

                        const apiResponseText = await generateBatchSummaries(batch);
                        processApiResponse(apiResponseText, batch);

                        // Re-render the articles after each batch completes.
                        // This will update the UI progressively.
                        renderArticles();
                    }
                    // *** END OF BATCHING LOGIC ***

                    // Hide progress bar
                    dom.progressContainer.classList.add('hidden');
                    dom.progressBar.style.width = '0%';

                    // Now that all batches are processed, save the complete session to history.
                    const newHistoryEntry = { id: Date.now(), timestamp: new Date().toISOString(), articles: state.currentArticles };
                    state.history.unshift(newHistoryEntry);
                    state.activeHistoryId = newHistoryEntry.id;
                    await saveDataToGist();
                    renderHistory();

                } catch (error) {
                    console.error('Error during batch processing:', error);
                    showError('Error processing articles: ' + error.message, 'globalError');
                    if (state.currentArticles && Array.isArray(state.currentArticles)) {
                        state.currentArticles.forEach(article => {
                            if (article && article.isLoading) { // Only mark failing ones
                                article.isLoading = false;
                                article.error = "Processing failed for this batch. " + error.message;
                            }
                        });
                        renderArticles();
                    }
                    // Hide progress bar on error
                    dom.progressContainer.classList.add('hidden');
                    dom.progressBar.style.width = '0%';
                }

                setProcessing(false);
            }

            // --- Rendering ---
            function renderHistory(searchTerm = '') {
                dom.historyList.innerHTML = '';

                const filteredHistory = searchTerm
                    ? state.history.filter(entry => {
                        const dateStr = new Date(entry.timestamp).toLocaleString().toLowerCase();
                        const articlesMatch = entry.articles.some(article =>
                            article.title.toLowerCase().includes(searchTerm) ||
                            (article.summary && article.summary.toLowerCase().includes(searchTerm))
                        );
                        return dateStr.includes(searchTerm) || articlesMatch;
                    })
                    : state.history;

                if (filteredHistory.length === 0 && searchTerm) {
                    dom.historyList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-tertiary); font-size: 0.875rem;">No matches found</div>';
                    return;
                }

                filteredHistory.forEach(entry => {
                    const el = document.createElement('button');
                    el.className = `history-item ${entry.id === state.activeHistoryId ? 'active' : ''}`;
                    el.dataset.id = entry.id;
                    el.innerHTML = `<div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div><div class="article-count">${entry.articles.length} article(s)</div>`;

                    // Add tooltip on hover
                    el.addEventListener('mouseenter', (e) => showHistoryTooltip(e, entry));
                    el.addEventListener('mouseleave', hideHistoryTooltip);

                    dom.historyList.appendChild(el);
                });
            }

            function showHistoryTooltip(e, entry) {
                if (!state.tooltip) {
                    state.tooltip = document.createElement('div');
                    state.tooltip.className = 'tooltip';
                    document.body.appendChild(state.tooltip);
                }

                const articleTitles = entry.articles
                    .slice(0, 3)
                    .map(a => `â¢ ${a.title}`)
                    .join('\n');

                const moreText = entry.articles.length > 3 ? `\n... and ${entry.articles.length - 3} more` : '';

                state.tooltip.innerHTML = `
                    <div class="tooltip-title">Session Preview</div>
                    <div class="tooltip-preview">${articleTitles}${moreText}</div>
                `;

                // Position tooltip
                const rect = e.currentTarget.getBoundingClientRect();
                state.tooltip.style.left = `${rect.right + 10}px`;
                state.tooltip.style.top = `${rect.top}px`;
                state.tooltip.classList.add('show');
            }

            function hideHistoryTooltip() {
                if (state.tooltip) {
                    state.tooltip.classList.remove('show');
                }
            }
            
            function renderArticles() {
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                state.currentArticles.forEach(article => {
                    fragment.appendChild(createArticleElement(article));
                });

                // Batch DOM update
                dom.articlesContainer.innerHTML = '';
                dom.articlesContainer.appendChild(fragment);

                updatePlaceholder();
                updateExpandAllButton();

                // Show/hide buttons based on whether we have articles
                if (state.currentArticles.length > 0) {
                    dom.statsBtn.classList.remove('hidden');
                    dom.expandAllBtn.classList.remove('hidden');
                    dom.exportBtn.classList.remove('hidden');
                } else {
                    dom.statsBtn.classList.add('hidden');
                    dom.expandAllBtn.classList.add('hidden');
                    dom.exportBtn.classList.add('hidden');
                }
            }

            function renderArticle(article) {
                const existingEl = document.querySelector(`.article-card[data-id='${article.id}']`);
                if (existingEl) existingEl.replaceWith(createArticleElement(article));
            }

            function createArticleElement(article) {
                const template = document.getElementById('articleTemplate').content.cloneNode(true);
                const card = template.querySelector('.article-card');
                card.dataset.id = article.id;
                template.querySelector('.article-title').textContent = article.title;
                template.querySelector('.full-article-box').textContent = article.content;

                const urlElement = template.querySelector('.article-url');
                if (article.url) {
                    urlElement.href = article.url;
                    const urlText = template.querySelector('.url-text');
                    try {
                        const domain = new URL(article.url).hostname.replace('www.', '');
                        urlText.textContent = domain;
                    } catch {
                        urlText.textContent = 'Source';
                    }
                    urlElement.classList.remove('hidden');
                    urlElement.addEventListener('click', (e) => e.stopPropagation());
                } else {
                    urlElement.classList.add('hidden');
                }

                const loaderIcon = template.querySelector('.loader-icon');
                const summaryContainer = template.querySelector('.summary-container');
                const chevronIcon = template.querySelector('.chevron-icon');
                const contentWrapper = template.querySelector('.article-content-wrapper');

                if (article.isLoading) {
                    loaderIcon.classList.remove('hidden');
                    summaryContainer.innerHTML = `<p>Generating summary...</p>`;
                } else if (article.error) {
                    summaryContainer.innerHTML = `<div class="alert-box"><strong>Error:</strong> ${article.error}</div>`;
                } else if (article.summary) {
                    loaderIcon.classList.add('hidden');
                    const summaryHtml = article.summary.split('\n').map(line => line.trim()).filter(line => line).map(line => `<li>${line.replace(/^[\*â¢-]\s*/, '')}</li>`).join('');
                    summaryContainer.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>5-Point Summary</h4>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="icon-btn share-btn" title="Share article" data-article-id="${article.id}">
                                    <svg class="icon" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                </button>
                                <button class="icon-btn regenerate-btn" title="Regenerate summary" data-article-id="${article.id}">
                                    <svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                </button>
                                <button class="icon-btn copy-summary-btn" title="Copy summary" data-summary="${article.summary.replace(/"/g, '&quot;')}" data-title="${article.title.replace(/"/g, '&quot;')}">
                                    <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="summary-box"><ul>${summaryHtml}</ul></div>
                    `;

                    // Add copy functionality
                    const copyBtn = summaryContainer.querySelector('.copy-summary-btn');
                    copyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        copyToClipboard(article.title, article.summary, copyBtn);
                    });

                    // Add share functionality
                    const shareBtn = summaryContainer.querySelector('.share-btn');
                    shareBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        shareArticle(article);
                    });

                    // Add regenerate functionality
                    const regenerateBtn = summaryContainer.querySelector('.regenerate-btn');
                    regenerateBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        regenerateArticleSummary(article.id);
                    });
                }

                if (state.expandedArticles.has(article.id)) {
                    contentWrapper.classList.remove('hidden');
                    chevronIcon.classList.add('expanded');
                } else {
                    contentWrapper.classList.add('hidden');
                    chevronIcon.classList.remove('expanded');
                }

                return template;
            }

            async function copyToClipboard(title, summary, button) {
                const text = `${title}\n\n${summary}`;
                try {
                    await navigator.clipboard.writeText(text);

                    // Visual feedback
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                    button.style.color = 'var(--success)';

                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.color = '';
                    }, 2000);
                } catch (error) {
                    console.error('Failed to copy:', error);
                    showError('Failed to copy to clipboard', 'globalError');
                    setTimeout(() => hideError('globalError'), 3000);
                }
            }

            async function regenerateArticleSummary(articleId) {
                const article = state.currentArticles.find(a => a.id === articleId);
                if (!article) return;

                // Set article to loading state
                article.isLoading = true;
                article.error = null;
                renderArticle(article);

                try {
                    // Generate new summary
                    const apiResponseText = await generateBatchSummaries([article]);
                    processApiResponse(apiResponseText, [article]);

                    // Update in history if this is from a saved session
                    if (state.activeHistoryId) {
                        const historyEntry = state.history.find(h => h.id === state.activeHistoryId);
                        if (historyEntry) {
                            const historyArticle = historyEntry.articles.find(a => a.id === articleId);
                            if (historyArticle) {
                                historyArticle.summary = article.summary;
                                historyArticle.title = article.title;
                                await saveDataToGist();
                            }
                        }
                    }

                    // Re-render article
                    renderArticle(article);
                } catch (error) {
                    console.error('Failed to regenerate summary:', error);
                    article.isLoading = false;
                    article.error = 'Failed to regenerate: ' + error.message;
                    renderArticle(article);
                }
            }
            
            function renderThemeModal() {
                dom.themeGrid.innerHTML = '';
                themes.forEach(theme => {
                    const swatch = document.createElement('div');
                    swatch.className = 'theme-swatch';
                    swatch.style.backgroundColor = theme.color;
                    swatch.dataset.theme = theme.id;
                    if (localStorage.getItem('glosaTheme') === theme.id) swatch.classList.add('active');
                    swatch.addEventListener('click', () => {
                        applyTheme(theme.id);
                        document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
                        swatch.classList.add('active');
                    });
                    dom.themeGrid.appendChild(swatch);
                });
            }
            // --- UI Interaction & Helpers ---
            function handleExpandAll() {
                if (state.allExpanded) {
                    state.expandedArticles.clear();
                    state.allExpanded = false;
                    dom.expandAllBtn.textContent = 'Expand All';
                } else {
                    state.currentArticles.forEach(article => {
                        state.expandedArticles.add(article.id);
                    });
                    state.allExpanded = true;
                    dom.expandAllBtn.textContent = 'Collapse All';
                }
                renderArticles();
            }
            
            function handleArticleClick(e) {
                const header = e.target.closest('.article-header');
                if (!header) return;
                
                const card = header.closest('.article-card');
                const articleIdStr = card.dataset.id;
                const articleId = parseInt(articleIdStr, 10);
                
                const wasExpanded = state.expandedArticles.has(articleId);
                const cardElements = Array.from(dom.articlesContainer.children);
                const currentIndex = cardElements.findIndex(el => el.dataset.id === articleIdStr);
                
                if (currentIndex !== -1) {
                    if (wasExpanded) {
                        // Collapse the entire row
                        collapseCardsInRow(currentIndex, cardElements);
                    } else {
                        // Expand the entire row
                        expandCardsInRow(currentIndex, cardElements);
                    }
                }
                
                updateExpandAllButton();
                renderArticles();
            }
            
            function expandCardsInRow(clickedIndex, cardElements) {
                const containerWidth = dom.articlesContainer.offsetWidth;
                const cardWidth = 400 + 24; // minmax(400px, 1fr) + gap
                const cardsPerRow = Math.floor(containerWidth / cardWidth) || 1;
                
                const rowStartIndex = Math.floor(clickedIndex / cardsPerRow) * cardsPerRow;
                const rowEndIndex = Math.min(rowStartIndex + cardsPerRow, cardElements.length);
                
                for (let i = rowStartIndex; i < rowEndIndex; i++) {
                    const cardId = parseInt(cardElements[i].dataset.id, 10);
                    state.expandedArticles.add(cardId);
                }
            }
            
            function collapseCardsInRow(clickedIndex, cardElements) {
                const containerWidth = dom.articlesContainer.offsetWidth;
                const cardWidth = 400 + 24; // minmax(400px, 1fr) + gap
                const cardsPerRow = Math.floor(containerWidth / cardWidth) || 1;
                
                const rowStartIndex = Math.floor(clickedIndex / cardsPerRow) * cardsPerRow;
                const rowEndIndex = Math.min(rowStartIndex + cardsPerRow, cardElements.length);
                
                for (let i = rowStartIndex; i < rowEndIndex; i++) {
                    const cardId = parseInt(cardElements[i].dataset.id, 10);
                    state.expandedArticles.delete(cardId);
                }
            }
            
            function updateExpandAllButton() {
                const allExpanded = state.currentArticles.every(article => state.expandedArticles.has(article.id));
                state.allExpanded = allExpanded;
                dom.expandAllBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
            }
            
            function handleHistoryClick(e) {
                const item = e.target.closest('.history-item');
                if (!item) return;
                const id = parseInt(item.dataset.id, 10);
                const historyEntry = state.history.find(entry => entry.id === id);
                if (historyEntry) {
                    state.currentArticles = historyEntry.articles.map(a => ({...a})); // Create copies
                    state.activeHistoryId = id;
                    dom.articlesInput.value = ''; 
                    state.expandedArticles.clear();
                    renderArticles(); 
                    renderHistory();
                }
            }
            
            function clearCurrentView() {
                state.currentArticles = []; 
                state.activeHistoryId = null;
                state.expandedArticles.clear();
                state.allExpanded = false;
                renderArticles(); 
                renderHistory();
            }

            function setProcessing(isLoading) {
                state.isProcessing = isLoading;
                dom.submitBtn.disabled = isLoading;
                dom.articlesInput.disabled = isLoading;
                const iconContainer = dom.submitBtnIconContainer;
                const textEl = dom.submitBtnText;
                
                if(isLoading) {
                    iconContainer.innerHTML = `<svg class="icon animate-spin" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;
                    textEl.textContent = 'Processing...';
                } else {
                    iconContainer.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>`;
                    textEl.textContent = 'Analyze & Save';
                }
            }
            
            function setButtonLoading(btn, isLoading, textEl, spinnerEl) {
                btn.disabled = isLoading;
                if (textEl) textEl.classList.toggle('hidden', isLoading);
                if (spinnerEl) spinnerEl.classList.toggle('hidden', !isLoading);
            }

            function showError(message, elementId) {
                const el = document.getElementById(elementId);
                el.innerHTML = `<span>${message}</span>`;
                el.classList.remove('hidden');
            }

            function hideError(elementId) {
                document.getElementById(elementId).classList.add('hidden');
            }
            
            function updatePlaceholder() {
                dom.articlesPlaceholder.classList.toggle('hidden', state.currentArticles.length > 0);
            }
            
            function applyTheme(themeId) {
                dom.html.className = themeId;
                localStorage.setItem('glosaTheme', themeId);
            }

            function loadTheme() {
                let savedTheme = localStorage.getItem('glosaTheme');

                // Auto-detect theme based on system preference if not set
                if (!savedTheme) {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    savedTheme = prefersDark ? 'theme-glosa' : 'theme-glosa-light';
                }

                applyTheme(savedTheme);

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    // Only auto-switch if user hasn't manually set a theme
                    if (!localStorage.getItem('glosaTheme')) {
                        const newTheme = e.matches ? 'theme-glosa' : 'theme-glosa-light';
                        applyTheme(newTheme);
                    }
                });
            }

            function handleExport() {
                if (state.currentArticles.length === 0) {
                    showError('No articles to export', 'globalError');
                    setTimeout(() => hideError('globalError'), 3000);
                    return;
                }

                // Create export menu
                const menu = document.createElement('div');
                menu.className = 'overlay';
                menu.innerHTML = `
                    <div class="modal-box">
                        <div class="modal-header"><h2>Export Articles</h2></div>
                        <div class="modal-body" style="gap: 0.75rem;">
                            <button class="btn btn-primary" id="exportMarkdown" style="width: 100%;">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                Export as Markdown
                            </button>
                            <button class="btn btn-secondary" id="exportJSON" style="width: 100%;">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                Export as JSON
                            </button>
                            <button class="btn btn-secondary" id="exportText" style="width: 100%;">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                Export as Plain Text
                            </button>
                            <button class="btn btn-secondary" id="cancelExport" style="width: 100%; margin-top: 0.5rem;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(menu);

                // Add event listeners
                document.getElementById('exportMarkdown').addEventListener('click', () => {
                    exportAsMarkdown();
                    menu.remove();
                });
                document.getElementById('exportJSON').addEventListener('click', () => {
                    exportAsJSON();
                    menu.remove();
                });
                document.getElementById('exportText').addEventListener('click', () => {
                    exportAsText();
                    menu.remove();
                });
                document.getElementById('cancelExport').addEventListener('click', () => menu.remove());
                menu.addEventListener('click', (e) => {
                    if (e.target === menu) menu.remove();
                });
            }

            function exportAsMarkdown() {
                let markdown = `# Glosa Export\n\nExported on: ${new Date().toLocaleString()}\n\n---\n\n`;

                state.currentArticles.forEach((article, index) => {
                    markdown += `## ${article.title}\n\n`;
                    if (article.url) {
                        markdown += `**Source:** [${article.url}](${article.url})\n\n`;
                    }
                    if (article.summary) {
                        markdown += `### Summary\n\n${article.summary}\n\n`;
                    }
                    if (index < state.currentArticles.length - 1) {
                        markdown += `---\n\n`;
                    }
                });

                downloadFile(markdown, 'glosa-export.md', 'text/markdown');
            }

            function exportAsJSON() {
                const exportData = {
                    exportedAt: new Date().toISOString(),
                    articlesCount: state.currentArticles.length,
                    articles: state.currentArticles.map(article => ({
                        title: article.title,
                        url: article.url,
                        summary: article.summary,
                        content: article.content
                    }))
                };

                downloadFile(JSON.stringify(exportData, null, 2), 'glosa-export.json', 'application/json');
            }

            function exportAsText() {
                let text = `Glosa Export\nExported on: ${new Date().toLocaleString()}\n\n${'='.repeat(80)}\n\n`;

                state.currentArticles.forEach((article, index) => {
                    text += `${article.title}\n${'-'.repeat(article.title.length)}\n\n`;
                    if (article.url) {
                        text += `Source: ${article.url}\n\n`;
                    }
                    if (article.summary) {
                        text += `Summary:\n${article.summary}\n\n`;
                    }
                    if (index < state.currentArticles.length - 1) {
                        text += `${'='.repeat(80)}\n\n`;
                    }
                });

                downloadFile(text, 'glosa-export.txt', 'text/plain');
            }

            function downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function showStatistics() {
                if (state.currentArticles.length === 0) return;

                // Calculate statistics
                const totalArticles = state.currentArticles.length;
                const totalWords = state.currentArticles.reduce((sum, article) => {
                    return sum + (article.content ? article.content.split(/\s+/).length : 0);
                }, 0);
                const avgWordsPerArticle = Math.round(totalWords / totalArticles);
                const estimatedReadingTime = Math.ceil(totalWords / 200); // Average reading speed: 200 words/min
                const articlesWithSummaries = state.currentArticles.filter(a => a.summary).length;
                const articlesWithUrls = state.currentArticles.filter(a => a.url).length;

                // Historical stats
                const totalHistoricalArticles = state.history.reduce((sum, entry) => sum + entry.articles.length, 0);
                const totalSessions = state.history.length;

                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="modal-box" style="max-width: 600px;">
                        <div class="modal-header"><h2>Statistics</h2></div>
                        <div class="modal-body">
                            <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary);">Current Session</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${totalArticles}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Total Articles</div>
                                </div>
                                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${totalWords.toLocaleString()}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Total Words</div>
                                </div>
                                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${avgWordsPerArticle}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Avg Words/Article</div>
                                </div>
                                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${estimatedReadingTime} min</div>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Est. Reading Time</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="flex: 1; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">${articlesWithSummaries}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">With Summaries</div>
                                </div>
                                <div style="flex: 1; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">${articlesWithUrls}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">With URLs</div>
                                </div>
                            </div>

                            <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary); border-top: 1px solid var(--border); padding-top: 1rem;">All Time</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${totalSessions}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Total Sessions</div>
                                </div>
                                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${totalHistoricalArticles}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary);">Total Articles</div>
                                </div>
                            </div>

                            <button class="btn btn-primary" id="closeStats" style="width: 100%; margin-top: 1.5rem;">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('closeStats').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }

            initializeApp();
        });
    </script>
</body>
</html>
